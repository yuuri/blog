# PG 常用命令

[TOC]



### 1. 查看数据库当前用户以及连接

```
select * from pg_stat_activity;
```

结果集会显示出当前连接的数据库名，用户，IP地址，连接开始时间，查询的语句等。

这里的pg_stat_activity其实是一个视图，它的定义可以在postgres这个数据库里面的视图部分找到，以下是它的定义：

> CREATE OR REPLACE VIEW pg_stat_activity AS SELECT s.datid, d.datname, s.procpid, s.usesysid, u.rolname AS usename, s.application_name, s.client_addr, s.client_hostname, s.client_port, s.backend_start, s.xact_start, s.query_start, s.waiting, s.current_query FROM pg_database d, pg_stat_get_activity(NULL::integer) s(datid, procpid, usesysid, application_name, current_query, waiting, xact_start, query_start, backend_start, client_addr, client_hostname, client_port), pg_authid u WHERE s.datid = d.oid AND s.usesysid = u.oid;

可以看到，pg_stat_activity这个视图是由 pg_database，pg_authid，以及两个方法的结果来组合成的。

pg_database ，顾名思义就是储存了在pg里面的所有的数据库名称。

pg_authid，是用来储存pg的登录账号。

pg_stat_get_backend_activity在Postgresql里面的定义如下：

> CREATE OR REPLACE FUNCTION pg_stat_get_backend_activity(integer) RETURNS text AS 'pg_stat_get_backend_activity' LANGUAGE internal STABLE STRICT COST 1; 
> ALTER FUNCTION pg_stat_get_backend_activity(integer) OWNER TO postgres; COMMENT ON FUNCTION pg_stat_get_backend_activity(integer) IS 'statistics: current query of backend';

可见它是一个pg的内部方法，用来统计当前query的数目。